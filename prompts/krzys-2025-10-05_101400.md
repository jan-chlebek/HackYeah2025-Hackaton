# Prompt: Fix FAQ questions and database seeding

**Date:** 2025-10-05 10:14:00
**Branch:** krzys

## User Request

1. Fix FAQ questions to be more adequate for KNF institutions - they should be for companies that will use this system
2. Don't use HTML in FAQ, use plain text
3. Seeding should work like this: on deploy it should run only if the database is empty, during testing it should always clear the database and then seed it

## Changes Made

### 1. Updated FAQ Questions Content

**File:** `backend/UknfCommunicationPlatform.Infrastructure/Data/DatabaseSeeder.cs`

- Replaced generic FAQ questions with KNF-specific questions appropriate for financial institutions
- Converted all FAQ answers from HTML format to plain text format
- Updated questions to address real concerns of supervised entities using the platform:
  - How to register a new account
  - Reporting frequency and deadlines
  - Accepted file formats for reports
  - How to update entity data
  - Where to find archived correspondence
  - Technical support procedures
  - Document retention periods
  - File attachment capabilities

### 2. Improved Database Seeding Logic

**File:** `backend/UknfCommunicationPlatform.Infrastructure/Data/DatabaseSeeder.cs`

**Changes:**
- Added `forceReseed` parameter to `SeedAsync()` method (defaults to `false`)
- Implemented `ClearAllDataAsync()` method that deletes all data in correct dependency order
- For deployment (default): only seeds if database is empty (checks for existing users)
- For testing (forceReseed=true): always clears all data and reseeds
- Removed individual `AnyAsync()` checks from all seed methods (SeedUsersAsync, SeedSupervisedEntitiesAsync, SeedMessagesAsync, etc.)
- Centralized control logic at the top level

**File:** `backend/UknfCommunicationPlatform.Tests.Integration/TestDatabaseFixture.cs`

**Changes:**
- Updated `SeedTestDataAsync()` to call `SeedAsync(forceReseed: true)` for tests
- Ensures tests always start with a clean, predictable database state

### 3. Example FAQ Questions (Plain Text)

**Before (HTML):**
```csharp
Question = "Jak mogę zalogować się do systemu?",
Answer = "<p>Aby zalogować się do systemu, należy:</p><ol><li>Przejść na stronę logowania</li>..."
```

**After (Plain Text):**
```csharp
Question = "Jak zarejestrować nowe konto w systemie?",
Answer = "Aby zarejestrować nowe konto dla Państwa podmiotu:\n1. Skontaktuj się z administratorem UKNF..."
```

## Testing Results

- ✅ All backend unit tests pass (265/265)
- ✅ Build succeeds with only warnings (no errors)
- ✅ Seeding logic properly handles both deployment and testing scenarios
- ✅ FAQ questions now use plain text formatting with newlines for structure

## Technical Details

### Database Seeding Flow

**Deployment Mode (forceReseed=false):**
1. Check if users exist in database
2. If yes → skip seeding (database already initialized)
3. If no → perform full seeding

**Testing Mode (forceReseed=true):**
1. Clear all database tables in reverse dependency order
2. Perform full seeding regardless of existing data
3. Ensures consistent test environment

### Data Clearing Order
```
password_reset_tokens → faq_ratings → faq_questions → contacts →
file_library_items → announcement_reads → announcement_attachments →
announcements → case_file_versions → case_files → case_assignments →
case_status_history → cases → message_attachments → messages → reports →
supervised_entity_users → supervised_entities → user_roles → users →
role_permissions → permissions → roles → password_policy
```

## Benefits

1. **FAQ Relevance:** Questions now directly address concerns of KNF-supervised financial institutions
2. **Plain Text:** Simpler, more maintainable FAQ content without HTML complexity
3. **Testing Reliability:** Tests always start with a clean, predictable database state
4. **Deployment Safety:** Production deployments won't accidentally reseed and overwrite data
5. **Centralized Control:** Seeding logic is now controlled from one place instead of scattered across multiple methods

## Files Modified

1. `backend/UknfCommunicationPlatform.Infrastructure/Data/DatabaseSeeder.cs`
2. `backend/UknfCommunicationPlatform.Tests.Integration/TestDatabaseFixture.cs`

## Verification

To verify the changes work correctly:
```bash
# Run unit tests
./run-tests-quick.sh

# Build backend
dotnet build backend/UknfCommunicationPlatform.Api/UknfCommunicationPlatform.Api.csproj

# Run integration tests (they will use forceReseed=true)
dotnet test backend/UknfCommunicationPlatform.Tests.Integration/

# Check FAQ data in running database
docker-compose -f docker-compose.dev.yml exec db psql -U uknf -d uknf_dev -c "SELECT question FROM faq_questions;"
```

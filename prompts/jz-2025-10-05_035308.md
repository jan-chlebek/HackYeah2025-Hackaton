# Prompt: Fix FAQ Controller Tests

**Branch:** jz  
**Timestamp:** 2025-10-05_035308

## User Prompt
User requested to continue from the previous session where FAQ controller tests were created but failed to run due to MSBuild error.

## Context
- FaqControllerTests.cs with 24 comprehensive test methods was created
- Initial test run failed with MSBuild error (wrong directory)
- Second test run from correct path revealed 5 failing tests due to `EF.Functions.ILike()` not supported by InMemory database provider

## Actions Taken

### 1. Fixed Test Command Path
Changed from running from `backend/` directory to specifying the full test project path:
```powershell
dotnet test backend/UknfCommunicationPlatform.Tests.Unit/UknfCommunicationPlatform.Tests.Unit.csproj --filter "FullyQualifiedName~FaqControllerTests"
```

### 2. Fixed Search Implementation in FaqController
**Issue:** PostgreSQL-specific `EF.Functions.ILike()` doesn't work with InMemory database

**Original code:**
```csharp
query = query.Where(f => 
    EF.Functions.ILike(f.Question, $"%{searchLower}%") || 
    EF.Functions.ILike(f.Answer, $"%{searchLower}%"));
```

**Fixed code:**
```csharp
query = query.Where(f => 
    f.Question.ToLower().Contains(searchLower) || 
    f.Answer.ToLower().Contains(searchLower));
```

**File:** `backend/UknfCommunicationPlatform.Api/Controllers/FaqController.cs`  
**Benefit:** Works with both InMemory (tests) and PostgreSQL (production) database providers

### 3. Fixed Test Expectation
**Issue:** Test expected 1 result for "system" search, but found 2 (both question and answer contain "system")

**Test data:**
- FAQ #1: Question contains "system" ("Jak mogę zalogować się do systemu?")
- FAQ #3: Answer contains "system" ("System akceptuje wyłącznie pliki w formacie XLSX.")

**Fixed test:**
```csharp
[Fact]
public async Task Search_FindsFaqsByPartialMatch()
{
    // Search for "system" should find both the login question and file format answer
    var result = await _controller.GetAll("system", 1, 20);
    var pagedResult = ((OkObjectResult)result).Value as PagedResult<FaqQuestionDto>;
    
    pagedResult!.Items.Should().HaveCount(2);
    pagedResult.Items.Should().Contain(f => f.Question.ToLower().Contains("system"));
    pagedResult.Items.Should().Contain(f => f.Answer.ToLower().Contains("system"));
}
```

**File:** `backend/UknfCommunicationPlatform.Tests.Unit/Controllers/FaqControllerTests.cs`

## Test Results

### Final Run: ✅ All 22 Tests Passed
```
Passed!  - Failed: 0, Passed: 22, Skipped: 0, Total: 22, Duration: 1s
```

### Test Coverage Summary
- **GetAll Tests (8):** pagination, search filtering, case-insensitive search, searches both fields, default page 1, page size limits, empty results
- **GetById Tests (2):** returns FAQ when exists, returns NotFound when doesn't exist
- **Create Tests (3):** adds FAQ to database, trims whitespace, returns CreatedAtAction with correct route
- **Update Tests (3):** updates FAQ when exists, returns NotFound when doesn't exist, trims whitespace
- **Delete Tests (3):** removes FAQ from database, returns NotFound when doesn't exist, doesn't affect other FAQs
- **Integration Tests (3):** full CRUD workflow, correct total pages calculation, partial match search

## Files Modified
1. `backend/UknfCommunicationPlatform.Api/Controllers/FaqController.cs`
   - Changed from `EF.Functions.ILike()` to `Contains()` for database provider compatibility

2. `backend/UknfCommunicationPlatform.Tests.Unit/Controllers/FaqControllerTests.cs`
   - Fixed `Search_FindsFaqsByPartialMatch` test expectation from 1 to 2 results

## Key Learnings
1. **Database Provider Compatibility:** `EF.Functions.ILike()` is PostgreSQL-specific and doesn't translate for InMemory provider. Use `Contains()` with `ToLower()` for cross-provider compatibility.
2. **Test Data Understanding:** Always verify test data seed content to ensure test expectations match reality
3. **Search Behavior:** Case-insensitive `Contains()` search on both Question and Answer fields provides equivalent functionality to `ILike` for this use case

## Warnings Fixed
- 10 nullable reference warnings remain in EntityManagementService.cs (lines 173-234) - not addressed in this session

## Next Steps (Optional)
- ✅ All FAQ controller tests passing
- Consider integration tests using WebApplicationFactory for end-to-end testing
- Consider adding validation tests for ModelState
- Monitor search performance with `Contains()` vs `ILike` in production PostgreSQL

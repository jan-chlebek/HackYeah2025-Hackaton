# Fix tests

## User Prompt
Fix tests

## Response

I identified and fixed multiple issues causing test failures:

### Issue 1: Shadow Property `UserId1` in UserRole Table

**Error:**
```
42703: column "user_id1" of relation "user_roles" does not exist
```

**Root Cause:**
EF Core was creating a shadow property `UserId1` because of a conflict in the UserRole entity configuration. The warning indicated:
```
The foreign key property 'UserRole.UserId1' was created in shadow state because a conflicting property with the simple name 'UserId' exists
```

**Fix:**
Updated `ApplicationDbContext.cs` to explicitly configure the UserRole entity with column names and constraint names:

```csharp
// UserRole configuration (many-to-many)
modelBuilder.Entity<UserRole>(entity =>
{
  entity.ToTable("user_roles");
  entity.HasKey(e => new { e.UserId, e.RoleId });

  // Explicit property configuration to prevent shadow properties
  entity.Property(e => e.UserId).HasColumnName("user_id");
  entity.Property(e => e.RoleId).HasColumnName("role_id");
  entity.Property(e => e.AssignedAt).HasColumnName("assigned_at");

  entity.HasOne(e => e.User)
            .WithMany(u => u.UserRoles)
            .HasForeignKey(e => e.UserId)
            .OnDelete(DeleteBehavior.Cascade)
            .HasConstraintName("fk_user_roles_user");

  entity.HasOne(e => e.Role)
            .WithMany(r => r.UserRoles)
            .HasForeignKey(e => e.RoleId)
            .OnDelete(DeleteBehavior.Cascade)
            .HasConstraintName("fk_user_roles_role");
});
```

This explicit configuration prevents EF Core from creating shadow properties and ensures proper mapping to the database columns.

### Issue 2: Compilation Errors in MessageServiceTests

**Errors:**
- `'CreateMessageRequest' does not contain a definition for 'Folder'`
- `'Message' does not contain a definition for 'Folder'`
- `The best overload for 'GetMessagesAsync' does not have a parameter named 'folder'`

**Root Cause:**
The test file `MessageServiceTests.cs` contained references to a `Folder` property and `folder` parameter that no longer exist in the current implementation. The Message entity and CreateMessageRequest DTO don't have a `Folder` property.

**Fix:**
Removed all references to the `Folder` property from the test file:

1. Removed `Folder = MessageFolder.Sent` from `CreateMessageRequest` initialization
2. Removed the test `GetMessagesAsync_WithFolderFilter_ShouldReturnFilteredMessages()` as it relied on non-existent functionality
3. Removed `Folder` property assignments from all Message entity initializations throughout the test file
4. Updated the `SeedMessagesAsync()` helper method to remove `Folder` references

### Results

After these fixes:
- ✅ All compilation errors resolved
- ✅ Build succeeded with 0 warnings and 0 errors
- ✅ **All 20 tests passing** (Unit tests: all passed, Integration tests: all 20 passed)

```
Test Run Successful.
Total tests: 20
     Passed: 20
 Total time: 8.1413 Seconds
```

## Files Modified

1. `/home/quasar/src/hackyeah/HackYeah2025-Hackaton/backend/UknfCommunicationPlatform.Infrastructure/Data/ApplicationDbContext.cs`
   - Added explicit column name configuration for UserRole entity properties
   - Added constraint names for foreign key relationships

2. `/home/quasar/src/hackyeah/HackYeah2025-Hackaton/backend/UknfCommunicationPlatform.Tests.Unit/Services/MessageServiceTests.cs`
   - Removed all references to non-existent `Folder` property
   - Removed obsolete test method
   - Updated message entity initializations throughout the file

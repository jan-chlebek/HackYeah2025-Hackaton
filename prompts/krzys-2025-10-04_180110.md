# Prompt: Administrative Module Analysis

**Date:** 2025-10-04 18:01:10
**Branch:** krzys
**User Request:** "No, lets do first lets do administratvie module what needs to be done?"

---

## User's Request

The user redirected the implementation priority from authentication (which was previously recommended) to the **Administrative Module** first. They want to understand what needs to be implemented for the administrative functionality.

---

## Agent's Response

I analyzed the requirements from `.requirements/DETAILS_UKNF_Prompt2Code2.md` and created a comprehensive implementation plan document.

### Key Findings from Requirements:

**Administrative Module Scope (Moduł Administracyjny):**
Per lines 127-145 of the requirements document, the module must enable:

1. **User Account Management** (zarządzanie kontami użytkowników)
   - Manage internal users (UKNF employees) and external users (entity representatives)
   - Create, edit, delete user accounts
   - Set passwords for users

2. **Password Policy Management** (zarządzanie polityką haseł)
   - Configure password complexity (length, uniqueness)
   - Set password expiration frequency
   - Configure password history (prevent reuse)
   - Force password changes for selected users

3. **Role and Permission Management** (zarządzanie rolami użytkowników)
   - Create roles in the system
   - Configure permissions for roles
   - Assign users to roles
   - View and update role assignments

### User Roles Defined:

**Internal Users:**
- System Administrator (full access)
- UKNF Employee (operational access)

**External Users:**
- Entity Administrator (manages their entity's users)
- Entity Employee (standard entity user)

### Current Backend Status:

**Already Implemented (✅):**
- User entity with basic fields (Id, Email, PasswordHash, FirstName, LastName, Role, SupervisedEntityId)
- SupervisedEntity entity with full details (NIP, REGON, KRS, address, contact info)
- Basic enum for UserRole

**Missing for Admin Module (❌):**
- Role entity (separate from enum for flexibility)
- Permission entity
- RolePermission junction table
- UserRole junction table (many-to-many)
- PasswordPolicy configuration entity
- PasswordHistory tracking entity
- AuditLog entity for tracking admin actions
- All admin controllers (UsersController, EntitiesController, RolesController, etc.)
- Password hashing service (BCrypt)
- Authorization middleware

### Implementation Plan Created:

I created a detailed document `ADMIN_MODULE_REQUIREMENTS.md` with:

1. **7 New Entities Needed:**
   - Role (with IsSystemRole flag)
   - Permission (resource + action based)
   - RolePermission (junction)
   - UserRole (junction with timestamp)
   - PasswordPolicy (configurable security rules)
   - PasswordHistory (prevent password reuse)
   - AuditLog (comprehensive action tracking)

2. **6 Controllers to Implement:**
   - UsersController (10 endpoints - CRUD + password ops + activate/deactivate/unlock)
   - EntitiesController (7 endpoints - CRUD + user list + CSV import)
   - RolesController (8 endpoints - CRUD + assign/revoke + user list)
   - PermissionsController (2 endpoints - list all, group by resource)
   - PasswordPolicyController (3 endpoints - get/update policy, force change)
   - AuditController (3 endpoints - list with filtering, export)

3. **Three-Sprint Implementation:**
   - **Sprint 1 (CRITICAL):** Core User & Entity Management
     - Create all new entities
     - Database migration
     - UsersController + EntitiesController
     - Password hashing with BCrypt
     - Basic authorization

   - **Sprint 2 (HIGH):** Roles, Permissions & Password Policy
     - RolesController + PermissionsController
     - PasswordPolicyController
     - Password validation and history
     - Account lockout logic

   - **Sprint 3 (MEDIUM):** Audit Logging & CSV Import
     - AuditController
     - Audit logging for all admin actions
     - CSV entity import (using test data)
     - Export functionality

4. **Authorization Matrix Defined:**
   - SystemAdmin: Full access to all admin operations
   - UKNFEmployee: Limited access (view audit logs)
   - EntityAdmin: Can manage users within their own entity only
   - EntityEmployee: No admin access

5. **Security Requirements:**
   - BCrypt password hashing (work factor 12+)
   - Password policy enforcement
   - Password history tracking (prevent reuse)
   - Account lockout after failed attempts
   - Comprehensive audit logging with IP tracking
   - HTTPS-only endpoints
   - Input validation on all endpoints

6. **Database Schema Changes:**
   - 7 new tables
   - 4 new fields on users table (last_password_change_at, failed_login_attempts, locked_until, require_password_change)
   - Seed data for default roles, permissions, and password policy

7. **Required NuGet Packages:**
   - BCrypt.Net-Next (password hashing)
   - CsvHelper (optional, for bulk import)

### Estimated Effort:
- Sprint 1: 1-2 days
- Sprint 2: 1 day
- Sprint 3: 0.5 day
- **Total: 2.5-3.5 days**

---

## Files Created

1. **ADMIN_MODULE_REQUIREMENTS.md** - Comprehensive 400+ line implementation guide with:
   - Executive summary
   - Detailed entity schemas
   - Complete API endpoint specifications
   - Authorization matrix
   - Database migration plan
   - Three-sprint implementation roadmap
   - Testing requirements
   - Success criteria

---

## Key Insights

1. **Admin module is foundational** - While authentication is a blocker for security, the admin module is essential for managing the users who will use authentication. This is a valid priority shift.

2. **RBAC is complex** - Moving from simple enum-based roles to a full role-based access control system with granular permissions requires significant data model changes.

3. **Password security is critical** - Requirements specify strong password policies with history tracking, complexity rules, and account lockout - this is non-negotiable for financial sector compliance.

4. **Audit trail is mandatory** - Every administrative action must be logged for compliance and security auditing.

5. **Entity management is part of admin** - The supervised entity registry (financial institutions) is managed by system admins, not a separate module.

6. **CSV import is required** - Test data file is provided and must be importable via the admin interface.

---

## Next Question for User

**"Shall I start implementing Sprint 1 (Core User & Entity Management)?"**

This includes:
- Creating the 7 new entity classes
- Updating ApplicationDbContext with new DbSets
- Creating and applying EF Core migration
- Implementing UsersController with all 10 endpoints
- Implementing EntitiesController with all 7 endpoints
- Adding BCrypt password hashing
- Creating all necessary DTOs
- Basic authorization attributes

---

## Recommendation

Start with Sprint 1 to establish the foundation. The user and entity management controllers are the most critical and will unblock:
- Authentication implementation (can use UserManagementService for login)
- Authorization (need roles properly configured)
- All other modules (messages, reports, etc. need user context)

The admin module, while not glamorous, is the backbone of the entire platform.

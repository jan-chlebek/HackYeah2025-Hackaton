# Prompt: Add FAQ Submit Question API Endpoint

**Branch:** jz  
**Date:** 2025-10-05 05:46:38  
**Task:** Add POST API endpoint for FAQ that accepts only a question (without answer)

## User Request
"Add API POST for faq, that add only question"

## Analysis

### Requirements
- Create a new POST endpoint that accepts only a question
- No answer required (will be empty until admin fills it)
- Allow anonymous/public submission
- Return created FAQ with empty answer
- Validate that question is not empty

### Use Case
1. External users or authenticated users submit questions they need answered
2. System stores question with empty answer field
3. UKNF administrators can later provide answers via existing PUT endpoint
4. Enables a self-service Q&A workflow

## Implementation

### API Endpoint Created

**Route:** `POST /api/v1/faq/submit-question`

**Request Body:**
```json
{
  "question": "Jak mogę zaktualizować dane mojej firmy?"
}
```

**Response:** `201 Created`
```json
{
  "id": 6,
  "question": "Jak mogę zaktualizować dane mojej firmy?",
  "answer": ""
}
```

**Authorization:** `[AllowAnonymous]` - Anyone can submit questions

**Validation:**
- Question cannot be empty or whitespace-only
- Question is trimmed automatically
- Returns `400 BadRequest` with ProblemDetails if validation fails

**Error Response:** `400 Bad Request`
```json
{
  "title": "Validation Error",
  "detail": "Question cannot be empty.",
  "status": 400,
  "instance": "/api/v1/faq/submit-question"
}
```

### Code Changes

#### 1. FaqController.cs - New Endpoint

**File:** `backend/UknfCommunicationPlatform.Api/Controllers/FaqController.cs`

Added new method `SubmitQuestion`:
- Validates question is not empty/whitespace
- Creates FaqQuestion with empty answer
- Saves to database
- Logs submission with question ID
- Returns `201 Created` with CreatedAtAction pointing to GetById
- Comprehensive XML documentation with examples and use case

#### 2. FaqController.cs - New DTO

Added `SubmitQuestionRequest` class:
```csharp
public class SubmitQuestionRequest
{
    public string Question { get; set; } = string.Empty;
}
```

#### 3. FaqControllerTests.cs - New Tests

**File:** `backend/UknfCommunicationPlatform.Tests.Unit/Controllers/FaqControllerTests.cs`

Added 6 comprehensive tests:

1. **SubmitQuestion_WithValidQuestion_ReturnsCreatedResult**
   - Validates 201 Created response
   - Verifies FaqQuestionDto structure
   - Checks question stored correctly
   - Verifies answer is empty
   - Confirms ID assigned

2. **SubmitQuestion_AddsQuestionToDatabase**
   - Verifies question persisted to database
   - Confirms answer is empty string
   - Uses database query for verification

3. **SubmitQuestion_TrimsWhitespace**
   - Tests leading/trailing whitespace removal
   - Verifies trimmed value in database

4. **SubmitQuestion_WithEmptyQuestion_ReturnsBadRequest**
   - Validates empty string rejected
   - Confirms 400 BadRequest response
   - Verifies ProblemDetails returned

5. **SubmitQuestion_WithWhitespaceOnly_ReturnsBadRequest**
   - Tests whitespace-only validation
   - Confirms proper error handling

6. **SubmitQuestion_ReturnsCreatedAtActionWithCorrectRoute**
   - Validates CreatedAtAction structure
   - Confirms route points to GetById
   - Verifies route values contain ID

## Issues Encountered & Fixes

### Issue: NullReferenceException in Tests

**Error:**
```
System.NullReferenceException : Object reference not set to an instance of an object.
at UknfCommunicationPlatform.Api.Controllers.FaqController.SubmitQuestion(SubmitQuestionRequest request)
in FaqController.cs:line 139
```

**Root Cause:**
- `HttpContext.Request.Path` is null in unit test environment
- ProblemDetails initialization failed when validation error occurred

**Fix:**
Changed from:
```csharp
Instance = HttpContext.Request.Path
```

To:
```csharp
Instance = HttpContext?.Request?.Path.Value ?? "/api/v1/faq/submit-question"
```

**Result:** Tests now pass with proper null-safety handling

## Test Execution Results

### Initial Run (With NullReferenceException)
```
Failed: 2, Passed: 4, Total: 6
- SubmitQuestion_WithEmptyQuestion_ReturnsBadRequest: FAILED
- SubmitQuestion_WithWhitespaceOnly_ReturnsBadRequest: FAILED
```

### After Fix
```
✅ All 6 SubmitQuestion tests passed
Duration: 2s
```

### Full Test Suite
```bash
dotnet test HackYeah2025-Hackaton.sln --verbosity minimal
```

**Result:** ✅ **222 total tests passed** (0 failed, 0 skipped)
- Unit tests: 202 (196 existing + 6 new)
- Integration tests: 20
- Duration: ~17s unit + ~12s integration = 29s total

## API Documentation

### Swagger/OpenAPI

The endpoint is fully documented with:
- **Summary:** Submit a new FAQ question (without answer)
- **Remarks:** Detailed use case explanation with example JSON
- **Parameters:** Request body documentation
- **Response codes:** 201 Created, 400 Bad Request
- **Examples:** Polish language question examples

### Key Features

1. **Anonymous Access:** No authentication required for submitting questions
2. **Validation:** Question cannot be empty or whitespace-only
3. **Data Sanitization:** Automatic whitespace trimming
4. **Proper REST:** Uses 201 Created with Location header via CreatedAtAction
5. **Error Handling:** Returns ProblemDetails for validation errors
6. **Logging:** Logs question submission with ID for audit trail
7. **Integration Ready:** Answer can be added later via existing PUT endpoint

## Workflow Integration

### Complete FAQ Lifecycle

1. **User submits question** → `POST /api/v1/faq/submit-question`
   - Question stored with empty answer
   - Returns question ID

2. **Admin retrieves questions** → `GET /api/v1/faq?search=`
   - Filter for empty answers to find unanswered questions
   - View all submitted questions

3. **Admin adds answer** → `PUT /api/v1/faq/{id}`
   - Updates question with answer
   - Requires authentication

4. **Public views FAQ** → `GET /api/v1/faq`
   - See all questions with answers
   - Search functionality available

## Testing Strategy

### Unit Test Coverage
- ✅ Happy path (valid question)
- ✅ Database persistence
- ✅ Data sanitization (whitespace trimming)
- ✅ Validation (empty string)
- ✅ Validation (whitespace only)
- ✅ REST convention (CreatedAtAction routing)

### Test Pattern
- **Arrange-Act-Assert** structure
- **FluentAssertions** for readable assertions
- **InMemoryDatabase** for isolated testing
- **No mocking** needed (direct DbContext usage)

## Coverage Summary

### Before Changes
- FAQ Controller: 5 endpoints (GET all, GET by ID, POST create, PUT update, DELETE)
- Test coverage: 16 tests

### After Changes
- FAQ Controller: 6 endpoints (added POST submit-question)
- Test coverage: 22 tests (+6 new tests)
- Endpoint coverage: 100% (all 6 endpoints tested)

## Key Learnings

1. **Null-Safety in Tests:** Always use null-conditional operators when accessing HttpContext properties in controllers
2. **ProblemDetails Pattern:** Standard way to return validation errors in ASP.NET Core APIs
3. **CreatedAtAction:** Proper REST convention for POST endpoints returning 201 Created
4. **AllowAnonymous:** Enables public API access for specific endpoints
5. **Empty vs Null:** Use empty string (`""`) instead of null for better handling in client applications

## Code Quality

- **XML Documentation:** Complete with examples and use cases
- **Validation:** Input validation with clear error messages
- **Logging:** Structured logging with context
- **Error Handling:** Proper HTTP status codes and ProblemDetails
- **Testing:** Comprehensive test coverage with edge cases
- **REST Conventions:** Follows standard practices (201 Created, Location header)

## Next Steps (Optional Enhancements)

1. **Rate Limiting:** Add rate limiting to prevent spam submissions
2. **Captcha:** Consider adding captcha for anonymous submissions
3. **Moderation:** Add approval workflow before questions are visible
4. **Notifications:** Email UKNF admins when new questions are submitted
5. **Analytics:** Track which questions are most commonly asked
6. **Search Index:** Index questions for better searchability

## Statistics

- **Files Modified:** 2
  1. `FaqController.cs` (+64 lines: 1 endpoint, 1 DTO)
  2. `FaqControllerTests.cs` (+130 lines: 6 tests)
- **Lines Added:** 194
- **Tests Written:** 6
- **Coverage Increase:** +1 endpoint (16.7% increase in FAQ endpoints)
- **Total Test Count:** 222 (202 unit + 20 integration)
- **Test Pass Rate:** 100%
- **Test Duration:** 29 seconds for full suite
- **Development Time:** ~15 minutes (including issue fix)

## Response Summary

Successfully implemented a new FAQ submission endpoint (`POST /api/v1/faq/submit-question`) that accepts only a question without requiring an answer. The endpoint is fully tested with 6 comprehensive unit tests covering happy path, validation, data sanitization, and REST conventions. Fixed one NullReferenceException issue related to HttpContext in tests. All 222 backend tests pass with no regressions. The endpoint enables a self-service Q&A workflow where users can submit questions anonymously and administrators can provide answers later via the existing PUT endpoint.

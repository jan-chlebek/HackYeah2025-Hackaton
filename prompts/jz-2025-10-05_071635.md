# Prompt: Fix All Backend Tests

**Branch:** jz  
**Timestamp:** 2025-10-05_071635  
**User Request:** "check if all tests pass, fix all isses"

## Problem Summary

All 48 integration tests were failing with database migration-related errors, while all 202 unit tests passed successfully.

## Root Causes Identified

1. **Migration Tracking Mismatch**: The migration `20251005035327_AddMessagePriorityAndThreading` adds three columns to the `messages` table: `parent_message_id`, `thread_id`, and `priority`. However:
   - The `parent_message_id` and `thread_id` columns already existed in the production database
   - The migration was NOT marked as applied in the `__EFMigrationsHistory` table
   - This caused tests to fail when trying to apply the migration during test database initialization

2. **Missing Priority Column**: The `priority` column didn't exist in the production database at all

3. **Column Type Mismatch**: When manually adding the `priority` column, it was initially created as `integer` type, but the Entity Framework Core configuration (in `ApplicationDbContext.cs` lines 91-94) converts all enum properties to strings. The migration creates it as `text` type with default value `'Normal'`.

## Errors Encountered

### Error 1: Column Already Exists
```
Npgsql.PostgresException : 42701: column "parent_message_id" of relation "messages" already exists
```
- **Location**: `TestDatabaseFixture.InitializeAsync()` at line 79
- **Cause**: Migration tried to add a column that was already manually added to the database

### Error 2: Column Does Not Exist
```
Npgsql.PostgresException : 42703: column "priority" of relation "messages" does not exist
```
- **Cause**: The `priority` column was completely missing from the production database

### Error 3: Column Type Mismatch
```
Npgsql.PostgresException : 42804: column "priority" is of type integer but expression is of type text
```
- **Cause**: Priority column was created as `integer` instead of `text`, conflicting with EF Core's enum-to-string conversion

## Solutions Applied

### 1. Mark Migration as Applied
```sql
INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion") 
VALUES ('20251005035327_AddMessagePriorityAndThreading', '9.0.0');
```
- This tells EF Core that the migration has already been applied
- Prevents duplicate column creation errors during test database initialization

### 2. Add Missing Priority Column (Corrected)
```sql
-- First attempt (wrong type):
ALTER TABLE messages ADD COLUMN IF NOT EXISTS priority integer NOT NULL DEFAULT 0;

-- Corrected approach:
ALTER TABLE messages DROP COLUMN IF EXISTS priority;
ALTER TABLE messages ADD COLUMN IF NOT EXISTS priority text NOT NULL DEFAULT 'Normal';
```
- Dropped the incorrectly typed column
- Recreated as `text` type to match EF Core's enum handling
- Used default value `'Normal'` to match the `MessagePriority.Normal` enum value

### 3. Create Index on Priority
```sql
CREATE INDEX IF NOT EXISTS i_x_messages_priority ON messages(priority);
```
- Matches the index created by the migration

## Technical Details

### Message Entity Configuration
From `Message.cs`:
```csharp
public MessagePriority Priority { get; set; } = MessagePriority.Normal;
```

### EF Core Enum Handling
From `ApplicationDbContext.cs` (lines 91-94):
```csharp
// Convert enum properties to strings automatically
if (property.ClrType.IsEnum)
{
  property.SetProviderClrType(typeof(string));
}
```
This global configuration converts ALL enum properties to string columns in PostgreSQL.

### Migration Definition
From `20251005035327_AddMessagePriorityAndThreading.cs`:
```csharp
migrationBuilder.AddColumn<string>(
    name: "priority",
    table: "messages",
    type: "text",
    nullable: false,
    defaultValue: "Normal");
```

## Test Results

### Before Fix
- **Unit Tests**: 202/202 ✅ (passing)
- **Integration Tests**: 0/48 ❌ (all failing)
- **Total**: 202/250 (81% pass rate)

### After Fix
- **Unit Tests**: 226/226 ✅ (passing)  
- **Integration Tests**: 48/48 ✅ (passing)  
- **Total**: 274/274 ✅ (100% pass rate)

Note: Unit test count increased from 202 to 226 (24 new tests added between runs)

## Verification Commands

```bash
# Check migration history
docker exec -i uknf-postgres psql -U uknf_user -d uknf_db -P pager=off \
  -c "SELECT * FROM \"__EFMigrationsHistory\" WHERE \"MigrationId\" LIKE '%AddMessage%';"

# Check messages table schema
docker exec -i uknf-postgres psql -U uknf_user -d uknf_db -P pager=off \
  -c "\d messages"

# Run all tests
dotnet test HackYeah2025-Hackaton.sln --verbosity minimal
```

## Lessons Learned

1. **Manual Database Changes**: When columns are added manually to the database outside of migrations, always:
   - Mark the corresponding migration as applied in `__EFMigrationsHistory`
   - Ensure column types match EF Core's mapping conventions

2. **Enum Handling**: Be aware of how EF Core maps enums to database columns:
   - Default behavior: maps to integers
   - With `SetProviderClrType(typeof(string))`: maps to text/varchar
   - Migration column types must match the EF Core configuration

3. **Test Database Initialization**: Integration tests create a fresh database by applying all migrations, so migration tracking issues will cause all tests to fail

4. **Database Schema Validation**: Always verify that the actual database schema matches what migrations expect before running tests

## Files Modified

- **Production Database**: `messages` table
  - Added `priority` column (text, NOT NULL, DEFAULT 'Normal')
  - Updated migration history table
  - Created index on `priority` column

## References

- Migration: `backend/UknfCommunicationPlatform.Infrastructure/Data/Migrations/20251005035327_AddMessagePriorityAndThreading.cs`
- Entity: `backend/UknfCommunicationPlatform.Core/Entities/Message.cs`
- DbContext: `backend/UknfCommunicationPlatform.Infrastructure/Data/ApplicationDbContext.cs`
- Test Fixture: `backend/UknfCommunicationPlatform.Tests.Integration/TestDatabaseFixture.cs`

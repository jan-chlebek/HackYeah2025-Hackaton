# Prompt: Authentication Testing with curl and Unit Tests

**Timestamp**: 2025-10-05_072908  
**Branch**: krzys  
**Context**: Testing authentication endpoints with curl and creating comprehensive integration tests

## User Request

```
Check with POST with curl that the authorization works and make an unit test for that - 
use the example credentials created in seeding the database.
```

## Response

I successfully tested the authentication endpoints with curl and created comprehensive integration tests using all the seeded credentials.

---

## Part 1: curl Testing

### Test Credentials from DatabaseSeeder

The following test credentials are seeded in the database:

| User Type      | Email                        | Password        | Role          |
|---------------|------------------------------|-----------------|---------------|
| Administrator | admin@uknf.gov.pl            | Admin123!       | Administrator |
| Internal User | jan.kowalski@uknf.gov.pl     | User123!        | InternalUser  |
| Supervisor    | anna.nowak@uknf.gov.pl       | Supervisor123!  | Supervisor    |

### Test 1: Admin Login ✅

```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@uknf.gov.pl",
    "password": "Admin123!"
  }'
```

**Result**: ✅ SUCCESS
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "VaGjxYgw2lmDoXSFkohf7j0f0bU1CcjBqQ/1n6OlrTtC5mu7vOz1WrK3...",
  "tokenType": "Bearer",
  "expiresIn": 3600,
  "user": {
    "id": 1,
    "email": "admin@uknf.gov.pl",
    "fullName": "Admin UKNF",
    "roles": ["Administrator"],
    "permissions": [
      "users.read", "users.write", "users.delete",
      "entities.read", "entities.write",
      "messages.read", "messages.write",
      "reports.read", "reports.write"
    ],
    "supervisedEntityId": null
  }
}
```

### Test 2: Wrong Password ✅

```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@uknf.gov.pl",
    "password": "WrongPassword"
  }'
```

**Result**: ✅ HTTP 401 Unauthorized
```json
{"message":"Invalid email or password"}
```

### Test 3: Internal User Login ✅

```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "jan.kowalski@uknf.gov.pl",
    "password": "User123!"
  }'
```

**Result**: ✅ SUCCESS
```json
{
  "email": "jan.kowalski@uknf.gov.pl",
  "roles": ["InternalUser"],
  "permissions": [
    "entities.read",
    "messages.read",
    "messages.write",
    "reports.read"
  ]
}
```

### Test 4: Supervisor Login ✅

```bash
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "anna.nowak@uknf.gov.pl",
    "password": "Supervisor123!"
  }'
```

**Result**: ✅ SUCCESS
```json
{
  "email": "anna.nowak@uknf.gov.pl",
  "roles": ["Supervisor"],
  "permissions": [
    "users.read",
    "entities.read", "entities.write",
    "messages.read", "messages.write",
    "reports.read", "reports.write"
  ]
}
```

---

## Part 2: Integration Tests

Created comprehensive integration test file: `AuthenticationEndpointTests.cs`

### Test Categories

#### 1. Login Tests (8 tests)
- ✅ `Login_WithAdminCredentials_ReturnsTokenAndAdministratorRole`
- ✅ `Login_WithInternalUserCredentials_ReturnsTokenAndInternalUserRole`
- ✅ `Login_WithSupervisorCredentials_ReturnsTokenAndSupervisorRole`
- ✅ `Login_WithInvalidPassword_ReturnsUnauthorized`
- ✅ `Login_WithNonExistentEmail_ReturnsUnauthorized`
- ✅ `Login_WithEmptyEmail_ReturnsBadRequest`
- ✅ `Login_WithEmptyPassword_ReturnsBadRequest`
- ✅ `Login_MultipleConcurrentSessions_AllReceiveDifferentTokens`

#### 2. Token Refresh Tests (3 tests)
- ✅ `RefreshToken_WithValidTokens_ReturnsNewTokens`
- ✅ `RefreshToken_WithInvalidAccessToken_ReturnsUnauthorized`
- ✅ `RefreshToken_WithEmptyTokens_ReturnsBadRequest`

#### 3. JWT Validation Tests (2 tests)
- ✅ `Login_ReturnsJwtWithCorrectClaims`
- ✅ `Login_TokenExpiresInOneHour`

### Test Implementation Highlights

**File**: `backend/UknfCommunicationPlatform.Tests.Integration/Controllers/AuthenticationEndpointTests.cs`

```csharp
[Collection(nameof(DatabaseCollection))]
public class AuthenticationEndpointTests : IClassFixture<TestDatabaseFixture>, IAsyncLifetime
{
    private readonly TestDatabaseFixture _factory;
    private readonly HttpClient _client;

    // Test credentials from DatabaseSeeder
    private const string AdminEmail = "admin@uknf.gov.pl";
    private const string AdminPassword = "Admin123!";
    private const string InternalUserEmail = "jan.kowalski@uknf.gov.pl";
    private const string InternalUserPassword = "User123!";
    private const string SupervisorEmail = "anna.nowak@uknf.gov.pl";
    private const string SupervisorPassword = "Supervisor123!";

    [Fact]
    public async Task Login_WithAdminCredentials_ReturnsTokenAndAdministratorRole()
    {
        // Arrange
        var loginRequest = new LoginRequest
        {
            Email = AdminEmail,
            Password = AdminPassword
        };

        // Act
        var response = await _client.PostAsJsonAsync("/api/v1/auth/login", loginRequest);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.OK);
        var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
        
        result.Should().NotBeNull();
        result!.AccessToken.Should().NotBeNullOrEmpty();
        result.RefreshToken.Should().NotBeNullOrEmpty();
        result.TokenType.Should().Be("Bearer");
        result.ExpiresIn.Should().BeGreaterThan(0);
        
        result.User.Email.Should().Be(AdminEmail);
        result.User.Roles.Should().Contain("Administrator");
        result.User.Permissions.Should().NotBeEmpty();
        // Validates all 9 admin permissions
        result.User.Permissions.Should().Contain("users.read");
        result.User.Permissions.Should().Contain("users.write");
        // ... etc
    }
}
```

**Key Features**:
1. Uses real database with seeded test data
2. Tests all 3 user types (Admin, InternalUser, Supervisor)
3. Validates JWT structure and claims
4. Tests error cases (wrong password, non-existent user, validation errors)
5. Tests token refresh flow
6. Validates permissions per role

---

## Test Results

### All Tests Pass ✅

```
╔════════════════════════════════════════════════════════════╗
║  Backend Unit Tests:        ✓ PASSED (227/227 tests)      ║
║  Backend Integration Tests: ✓ PASSED (79/79 tests)        ║
║                                                            ║
║  Total Tests:               306                            ║
║  Passed:                    306 (100%)                     ║
║  Failed:                    0                              ║
╚════════════════════════════════════════════════════════════╝
```

**New Authentication Tests**: 13/13 passed (100%)

**Test Execution Time**: ~500ms for all authentication tests

---

## Permissions Verified by Tests

### Administrator Role
- ✅ users.read, users.write, users.delete
- ✅ entities.read, entities.write
- ✅ messages.read, messages.write
- ✅ reports.read, reports.write

### InternalUser Role
- ✅ entities.read
- ✅ messages.read, messages.write
- ✅ reports.read

### Supervisor Role
- ✅ users.read
- ✅ entities.read, entities.write
- ✅ messages.read, messages.write
- ✅ reports.read, reports.write

---

## What Was Tested

### ✅ Successful Authentication
- Admin login with all permissions
- Internal user login with limited permissions
- Supervisor login with supervisory permissions
- JWT token generation (access + refresh)
- Token expiration (3600 seconds = 1 hour)
- Concurrent sessions with different tokens

### ✅ Authentication Failures
- Wrong password → 401 Unauthorized
- Non-existent email → 401 Unauthorized
- Empty email → 400 Bad Request
- Empty password → 400 Bad Request

### ✅ Token Refresh
- Valid token refresh → new tokens generated
- Invalid tokens → 401 Unauthorized
- Empty tokens → 400 Bad Request

### ✅ JWT Structure
- 3-part JWT (header.payload.signature)
- Contains email claim
- Contains role claim
- Contains issuer (iss)
- Contains audience (aud)
- Contains expiration (exp)

---

## Files Created/Modified

1. ✅ **New Test File**: `backend/UknfCommunicationPlatform.Tests.Integration/Controllers/AuthenticationEndpointTests.cs`
   - 13 comprehensive authentication tests
   - Tests all seeded user types
   - Validates JWT structure and claims
   - Tests error scenarios

---

## Summary

Successfully validated the authentication system with both manual curl testing and automated integration tests:

1. **curl Testing**: ✅ All 4 manual tests passed
   - Admin login works
   - Internal user login works
   - Supervisor login works
   - Wrong password correctly rejected

2. **Integration Tests**: ✅ All 13 automated tests passed
   - Login with valid credentials (3 user types)
   - Login with invalid credentials (4 error cases)
   - Token refresh (3 scenarios)
   - JWT validation (2 tests)
   - Concurrent sessions (1 test)

3. **Overall Test Suite**: ✅ 306/306 tests passing (100%)
   - 227 unit tests
   - 79 integration tests (including 13 new auth tests)

The authentication system is fully tested and working correctly with all seeded credentials! 🎉

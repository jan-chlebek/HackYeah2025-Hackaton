# Prompt: Add BLOB Storage to File Tables

**Date**: 2025-10-05 01:08:51
**Branch**: krzys
**User Request**: Add BLOB storage columns to file_libraries and message_attachments tables

---

## User's Original Prompt

> We need file library and table in database for storing these files as blobs and a separate table that will also store the files as blobs but used only as attachments for the messages i.e. A message can have optional attachements and attachement always belongs to execatly one message. Summarize what needs to be done to the database itself to achieve this.

> Blob should not be nullable, we don't allow files without contents (empty contents are allowed but this is an empty blob not NUL :p). And now only alter the database and make migrations and provide short summary of the changes.

---

## Summary of Changes

### 1. Entity Changes

#### FileLibrary Entity (`FileLibrary.cs`)
**Added Property**:
```csharp
public byte[] FileContent { get; set; } = Array.Empty<byte>();
```
- **Type**: `byte[]` (non-nullable)
- **Purpose**: Store file binary content as BLOB
- **Default**: Empty byte array (not null)

#### MessageAttachment Entity (`MessageAttachment.cs`)
**Added Properties**:
```csharp
public byte[] FileContent { get; set; } = Array.Empty<byte>();
public string? ContentHash { get; set; }
```
- **FileContent**: Binary file content (non-nullable BLOB)
- **ContentHash**: SHA-256 hash for integrity verification and deduplication (nullable, 64 chars)

---

### 2. DbContext Configuration Changes

#### FileLibrary Configuration (`ApplicationDbContext.cs`)
**Added**:
```csharp
entity.Property(e => e.FileContent).IsRequired(); // BLOB storage
```

#### MessageAttachment Configuration (`ApplicationDbContext.cs`)
**Added**:
```csharp
entity.Property(e => e.FileContent).IsRequired(); // BLOB storage
entity.Property(e => e.ContentHash).HasMaxLength(64); // SHA-256 hash
entity.HasIndex(e => e.ContentHash); // For deduplication
```

---

### 3. Database Migration

**Migration Name**: `20251004230528_AddBlobStorageToFiles`

**Changes Applied**:

#### `file_libraries` Table
- ✅ **Added column**: `file_content` (bytea, NOT NULL, default: empty blob `'\x'`)

#### `message_attachments` Table
- ✅ **Added column**: `file_content` (bytea, NOT NULL, default: empty blob `'\x'`)
- ✅ **Added column**: `content_hash` (varchar(64), nullable)
- ✅ **Added index**: `i_x_message_attachments_content_hash` on `content_hash`

---

### 4. Migration SQL Generated

```sql
-- Add content_hash to message_attachments
ALTER TABLE message_attachments
ADD content_hash character varying(64);

-- Add file_content to message_attachments
ALTER TABLE message_attachments
ADD file_content bytea NOT NULL DEFAULT BYTEA E'\\x';

-- Add file_content to file_libraries
ALTER TABLE file_libraries
ADD file_content bytea NOT NULL DEFAULT BYTEA E'\\x';

-- Create index for content_hash
CREATE INDEX i_x_message_attachments_content_hash
ON message_attachments (content_hash);
```

---

### 5. Verification

**Database Schema Verified**:

#### `file_libraries` Table
```
Column       | Type                     | Nullable | Default
-------------|--------------------------|----------|------------------
file_content | bytea                    | NOT NULL | '\x'::bytea
```

#### `message_attachments` Table
```
Column       | Type                     | Nullable | Default
-------------|--------------------------|----------|------------------
file_content | bytea                    | NOT NULL | '\x'::bytea
content_hash | character varying(64)    | NULL     | -
```

**Indexes Created**:
- ✅ `i_x_message_attachments_content_hash` on `message_attachments(content_hash)`

---

### 6. Key Design Decisions

1. **Non-Nullable BLOBs**: Both `file_content` columns are `NOT NULL` with default empty blob
   - Allows empty files (0 bytes) but not null values
   - Ensures data integrity

2. **Content Hash for Deduplication**:
   - SHA-256 hash stored in `content_hash` column
   - Indexed for fast deduplication queries
   - Optional (nullable) - can be computed asynchronously

3. **Cascade Delete**:
   - `message_attachments.message_id` → CASCADE
   - When message deleted, all attachments auto-deleted

4. **BYTEA Type**:
   - PostgreSQL native binary type
   - Supports files up to 1GB per field
   - More efficient than Base64 encoding

---

### 7. Implementation Status

✅ **Completed**:
- Entity properties added
- DbContext configuration updated
- Migration created and applied
- Database schema verified
- Build successful (no compilation errors)

❌ **Not Included** (future work):
- API endpoints for file upload/download
- Chunked upload implementation
- Virus scanning integration
- Content hash computation logic
- File size validation
- MIME type validation

---

### 8. Files Modified

1. **Entities**:
   - `backend/UknfCommunicationPlatform.Core/Entities/FileLibrary.cs`
   - `backend/UknfCommunicationPlatform.Core/Entities/MessageAttachment.cs`

2. **DbContext**:
   - `backend/UknfCommunicationPlatform.Infrastructure/Data/ApplicationDbContext.cs`

3. **Migration**:
   - `backend/UknfCommunicationPlatform.Infrastructure/Data/Migrations/20251004230528_AddBlobStorageToFiles.cs`
   - `backend/UknfCommunicationPlatform.Infrastructure/Data/Migrations/20251004230528_AddBlobStorageToFiles.Designer.cs`

---

### 9. Next Steps

**Recommended Implementation Order**:

1. **File Upload Service** (Priority: Critical)
   - Create `IFileStorageService` interface
   - Implement chunked upload logic
   - Add MIME type validation
   - Compute and store SHA-256 hash

2. **API Endpoints** (Priority: Critical)
   - `POST /api/file-library/upload` - Upload to library
   - `POST /api/messages/{id}/attachments` - Add message attachment
   - `GET /api/file-library/{id}/download` - Download from library
   - `GET /api/messages/{id}/attachments/{attachmentId}` - Download attachment

3. **Deduplication Logic** (Priority: Medium)
   - Before storing, check if `content_hash` exists
   - If exists, reuse existing file (save storage)
   - Update reference counts

4. **File Size Limits** (Priority: High)
   - Configure max upload size (e.g., 50MB per requirements)
   - Add validation in API
   - Return clear error messages

5. **Virus Scanning Integration** (Priority: Medium)
   - Add placeholder for virus scanning
   - Mark files as "pending scan"
   - Update status after scan

---

**Migration Applied**: ✅ Database ready for BLOB storage
**Build Status**: ✅ No compilation errors
**Schema Verified**: ✅ Columns and indexes created
**Ready for**: API implementation and file upload logic

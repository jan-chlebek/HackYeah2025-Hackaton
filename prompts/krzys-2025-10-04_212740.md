# Prompt: Implement missing Message API backend module

**Date:** 2025-10-04 21:27:40
**Branch:** krzys
**User Request:**
> Why backend API for message module is missing? Implement it!

## Response Summary

Successfully implemented the complete Messages API backend module with full CRUD operations, filtering, pagination, and message management features.

## What Was Implemented

### 1. Data Transfer Objects (DTOs)

Created comprehensive DTOs for message operations:

**`CreateMessageRequest.cs`**
- Subject, Body (with validation)
- RecipientId (optional for drafts)
- Folder classification (Inbox, Sent, Drafts, Reports, Cases, Applications)
- Thread and parent message support for conversations
- Related entity/report/case linking
- SendImmediately flag for drafts vs immediate send

**`UpdateMessageRequest.cs`**
- Partial update support for draft messages
- Subject, Body, RecipientId updates

**`MessageResponse.cs`**
- Complete message data with sender/recipient info
- Status, folder, threading information
- Read status and timestamps
- Related entity details
- Attachment and reply counts
- Cancellation support

**`MessageDetailResponse.cs`**
- Extended response with full conversation thread
- List of replies with nested message data
- Attachment information with metadata

### 2. Message Service (`MessageService.cs`)

Implemented comprehensive message management service:

**Core Operations:**
- `GetMessagesAsync` - Paginated message list with filtering by folder, read status, search term, related entity
- `GetMessageByIdAsync` - Get full message details with replies and attachments
- `CreateMessageAsync` - Create new message or draft
- `UpdateMessageAsync` - Update draft messages
- `DeleteDraftAsync` - Delete unsent drafts

**Status Management:**
- `MarkAsReadAsync` - Mark single message as read
- `MarkMultipleAsReadAsync` - Bulk mark as read
- `SendDraftAsync` - Send a draft message
- `CancelMessageAsync` - Cancel sent message before it's read

**Statistics:**
- `GetUnreadCountAsync` - Get unread message count
- `GetMessageStatsAsync` - Get inbox/sent/drafts/unread counts

### 3. Messages Controller (`MessagesController.cs`)

Created RESTful API endpoints:

**GET Endpoints:**
- `GET /api/v1/messages` - List messages with pagination & filters
- `GET /api/v1/messages/{id}` - Get message details
- `GET /api/v1/messages/unread-count` - Get unread count
- `GET /api/v1/messages/stats` - Get message statistics

**POST Endpoints:**
- `POST /api/v1/messages` - Create new message/draft
- `POST /api/v1/messages/{id}/read` - Mark as read
- `POST /api/v1/messages/read-multiple` - Bulk mark as read
- `POST /api/v1/messages/{id}/send` - Send draft
- `POST /api/v1/messages/{id}/cancel` - Cancel message

**PUT/DELETE Endpoints:**
- `PUT /api/v1/messages/{id}` - Update draft
- `DELETE /api/v1/messages/{id}` - Delete draft

All endpoints:
- ✅ Require authentication
- ✅ Extract user ID from JWT token
- ✅ Include proper authorization checks
- ✅ Return appropriate HTTP status codes
- ✅ Include Swagger documentation

### 4. Service Registration

Updated `ServiceCollectionExtensions.cs` to register `MessageService` in the DI container.

## API Features

### Message Filtering
- By folder (Inbox, Sent, Drafts, Reports, Cases, Applications)
- By read status (read/unread)
- By search term (searches subject and body)
- By related supervised entity
- Pagination with configurable page size

### Message Status Flow
1. **Draft** → Created but not sent
2. **Sent** → Delivered to recipient
3. **Read** → Opened by recipient
4. **AwaitingUknfResponse** / **AwaitingUserResponse** - For tracking conversations
5. **Closed** → Conversation complete
6. **Cancelled** → Message cancelled before being read

### Conversation Threading
- Messages can be grouped into threads via `ThreadId`
- Messages can reply to other messages via `ParentMessageId`
- Full conversation history retrievable via detail endpoint

### Security
- All endpoints require authentication
- User can only access their own messages (sender or recipient)
- Draft messages only accessible by sender
- JWT token claims used for user identification

## Testing

All existing tests continue to pass:
- ✅ 83/83 unit tests passed
- ✅ 8/8 integration tests passed
- ✅ Total: 91/91 tests passing

Build completed successfully with only minor warnings (null reference assignments in unrelated code).

## Files Created/Modified

### Created:
- `backend/UknfCommunicationPlatform.Core/DTOs/Messages/CreateMessageRequest.cs`
- `backend/UknfCommunicationPlatform.Core/DTOs/Messages/UpdateMessageRequest.cs`
- `backend/UknfCommunicationPlatform.Core/DTOs/Messages/MessageResponse.cs`
- `backend/UknfCommunicationPlatform.Core/DTOs/Messages/MessageDetailResponse.cs`
- `backend/UknfCommunicationPlatform.Infrastructure/Services/MessageService.cs`
- `backend/UknfCommunicationPlatform.Api/Controllers/v1/MessagesController.cs`

### Modified:
- `backend/UknfCommunicationPlatform.Infrastructure/Extensions/ServiceCollectionExtensions.cs` - Added MessageService registration

## API Documentation

The Messages API is now fully documented in Swagger with:
- Detailed endpoint descriptions
- Request/response schemas
- Status code documentation
- Parameter descriptions
- Authentication requirements

## Next Steps

The Messages API is now complete and ready for frontend integration. Additional features that could be added:
- Message attachment upload/download endpoints
- Real-time notifications (SignalR)
- Message templates
- Automated message categorization
- Full-text search improvements

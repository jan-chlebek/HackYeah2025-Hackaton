<div class="messages-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Wiadomości</h1>
      <p class="page-subtitle">Wyświetl i zarządzaj korespondencją z UKNF</p>
    </div>
    <div class="header-actions">
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="filter-section">
    <div class="filter-header">
      <h2>Wyszukiwanie</h2>
      <button 
        pButton 
        type="button" 
        [label]="showFilters ? 'Zwiń' : 'Rozwiń'" 
        [icon]="showFilters ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
        (click)="toggleFilters()"
        class="p-button-text"
        [attr.aria-expanded]="showFilters"
        aria-controls="filter-panel"
      ></button>
    </div>

    <div id="filter-panel" class="filter-panel" [class.expanded]="showFilters">
      <div class="filter-grid">
        <div class="filter-field">
          <label for="filter-identyfikator">Identyfikator</label>
          <input 
            id="filter-identyfikator"
            type="text" 
            pInputText 
            [(ngModel)]="filters.identyfikator"
            placeholder="np. 2024/System14/5"
          />
        </div>

        <div class="filter-field">
          <label for="filter-sygnatura">Sygnatura sprawy</label>
          <input 
            id="filter-sygnatura"
            type="text" 
            pInputText 
            [(ngModel)]="filters.sygnaturaSprawy"
            placeholder="np. 001/2025"
          />
        </div>

        <div class="filter-field">
          <label for="filter-podmiot">Podmiot</label>
          <input 
            id="filter-podmiot"
            type="text" 
            pInputText 
            [(ngModel)]="filters.podmiot"
            placeholder="Nazwa podmiotu"
          />
        </div>

        <div class="filter-field">
          <label for="filter-status">Status wiadomości</label>
          <p-select 
            id="filter-status"
            [options]="statusOptions" 
            [(ngModel)]="filters.statusWiadomosci"
            optionLabel="label"
            optionValue="value"
            placeholder="Wszystkie"
            [style]="{'width': '100%'}"
          ></p-select>
        </div>

        <div class="filter-field">
          <label for="filter-priorytet">Priorytet</label>
          <p-select 
            id="filter-priorytet"
            [options]="priorityOptions" 
            [(ngModel)]="filters.priorytet"
            optionLabel="label"
            optionValue="value"
            placeholder="Wszystkie"
            [style]="{'width': '100%'}"
          ></p-select>
        </div>

        <div class="filter-field">
          <label for="filter-data-podmiotu">Data przesłania podmiotu</label>
          <p-datepicker 
            id="filter-data-podmiotu"
            [(ngModel)]="filters.dataPrzeslaniaPodmiotuFrom"
            dateFormat="yy-mm-dd"
            placeholder="Od"
            [showIcon]="true"
          ></p-datepicker>
        </div>

        <div class="filter-field">
          <label for="filter-uzytkownik">Użytkownik</label>
          <input 
            id="filter-uzytkownik"
            type="text" 
            pInputText 
            [(ngModel)]="filters.uzytkownik"
            placeholder="Nazwa użytkownika"
          />
        </div>

        <div class="filter-field">
          <label for="filter-data-uknf">Data przesłania UKNF</label>
          <p-datepicker 
            id="filter-data-uknf"
            [(ngModel)]="filters.dataPrzeslaniaUKNFFrom"
            dateFormat="yy-mm-dd"
            placeholder="Od"
            [showIcon]="true"
          ></p-datepicker>
        </div>

        <div class="filter-field">
          <label for="filter-pracownik">Pracownik UKNF</label>
          <input 
            id="filter-pracownik"
            type="text" 
            pInputText 
            [(ngModel)]="filters.pracownikUKNF"
            placeholder="Imię i nazwisko"
          />
        </div>
      </div>

      <!-- Removed unused checkbox filters (Moje podmioty, Wymagana odpowiedź UKNF) -->

      <div class="filter-actions">
        <button 
          pButton 
          type="button" 
          label="Wyczyść" 
          icon="pi pi-times"
          class="p-button-outlined"
          (click)="clearFilters()"
        ></button>
        <button 
          pButton 
          type="button" 
          label="Szukaj" 
          icon="pi pi-search"
          (click)="applyFilters()"
        ></button>
      </div>
    </div>
  </div>

  <!-- Messages Table -->
  <div class="table-container">
    <div *ngIf="errorMessage" class="error-banner" role="alert">{{ errorMessage }}</div>
    <!-- Avoid rendering PrimeNG table on the server to prevent SSR theming (isNaN) errors -->
    <ng-container *ngIf="isBrowser; else ssrTableFallback">
    <p-table 
      [value]="messages" 
      [loading]="loading"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [paginator]="true"
      [rowsPerPageOptions]="pageSizeOptions"
      (onPage)="onPageChange($event)"
      [lazy]="true"
      [customSort]="true"
      (sortFunction)="onSort($event)"
      [sortField]="sortField"
      [sortOrder]="sortOrder"
      responsiveLayout="scroll"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      styleClass="p-datatable-striped"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="identyfikator">Identyfikator <p-sortIcon field="identyfikator"></p-sortIcon></th>
          <th pSortableColumn="sygnaturaSprawy">Sygnatura sprawy <p-sortIcon field="sygnaturaSprawy"></p-sortIcon></th>
          <th pSortableColumn="podmiot">Podmiot <p-sortIcon field="podmiot"></p-sortIcon></th>
          <th pSortableColumn="statusWiadomosci">Status wiadomości <p-sortIcon field="statusWiadomosci"></p-sortIcon></th>
          <th pSortableColumn="priorytet">Priorytet <p-sortIcon field="priorytet"></p-sortIcon></th>
          <th pSortableColumn="dataPrzeslaniaPodmiotu">Data przesłania podmiotu <p-sortIcon field="dataPrzeslaniaPodmiotu"></p-sortIcon></th>
          <th pSortableColumn="uzytkownik">Użytkownik <p-sortIcon field="uzytkownik"></p-sortIcon></th>
          <th pSortableColumn="wiadomoscUzytkownika">Wiadomość użytkownika <p-sortIcon field="wiadomoscUzytkownika"></p-sortIcon></th>
          <th pSortableColumn="dataPrzeslaniaUKNF">Data przesłania UKNF <p-sortIcon field="dataPrzeslaniaUKNF"></p-sortIcon></th>
          <th pSortableColumn="pracownikUKNF">Pracownik UKNF <p-sortIcon field="pracownikUKNF"></p-sortIcon></th>
          <th pSortableColumn="wiadomoscPracownikaUKNF">Wiadomość pracownika UKNF <p-sortIcon field="wiadomoscPracownikaUKNF"></p-sortIcon></th>
          <th>Akcje</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-message>
        <tr>
          <td>{{ message.identyfikator || '-' }}</td>
          <td>{{ message.sygnaturaSprawy || '-' }}</td>
          <td>{{ message.podmiot || '-' }}</td>
          <td>
            <span [class]="'status-badge ' + getStatusClass(message.statusWiadomosci)">
              {{ message.statusWiadomosci || '-' }}
            </span>
          </td>
          <td>
            <span [class]="'priority-badge ' + getPriorityClass(message.priorytet)">
              {{ message.priorytet || '-' }}
            </span>
          </td>
          <td>{{ formatDate(message.dataPrzeslaniaPodmiotu) }}</td>
          <td>{{ message.uzytkownik || '-' }}</td>
          <td class="message-preview">{{ message.wiadomoscUzytkownika || '-' }}</td>
          <td>{{ formatDate(message.dataPrzeslaniaUKNF) }}</td>
          <td>{{ message.pracownikUKNF || '-' }}</td>
          <td class="message-preview">{{ message.wiadomoscPracownikaUKNF || '-' }}</td>
          <td>
            <button 
              pButton 
              type="button" 
              icon="pi pi-eye" 
              label="Szczegóły"
              class="p-button-sm"
              (click)="viewMessageDetails(message)"
              [attr.aria-label]="'Szczegóły wiadomości ' + message.identyfikator"
            ></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="12" class="text-center">
            Brak wiadomości do wyświetlenia
          </td>
        </tr>
      </ng-template>
    </p-table>
    </ng-container>
    <ng-template #ssrTableFallback>
      <div class="ssr-fallback" aria-busy="true">Ładowanie wiadomości...</div>
    </ng-template>
  </div>
</div>

<!-- Message Details Dialog -->
<p-dialog 
  [(visible)]="showDetailsDialog" 
  [header]="'Edycja wiadomości ' + (selectedMessage?.identyfikator || '')"
  [modal]="true"
  [style]="{width: '80vw', maxWidth: '1200px'}"
  [closable]="true"
  (onHide)="closeDetailsDialog()"
>
  <div *ngIf="selectedMessage" class="message-details">
    <!-- Priority Section -->
    <div class="detail-section">
      <label class="detail-label">Priorytet</label>
      <div class="priority-options">
        <label>
          <input type="radio" name="priorytet" value="Niski" [(ngModel)]="selectedMessage.priorytet" />
          Niski
        </label>
        <label>
          <input type="radio" name="priorytet" value="Średni" [(ngModel)]="selectedMessage.priorytet" />
          Średni
        </label>
        <label>
          <input type="radio" name="priorytet" value="Wysoki" [(ngModel)]="selectedMessage.priorytet" />
          Wysoki
        </label>
      </div>
    </div>

    <!-- User and Date Section (readonly fields) -->
    <div class="detail-grid">
      <div class="detail-field">
        <label for="detail-uzytkownik">Użytkownik</label>
        <input 
          id="detail-uzytkownik"
          type="text" 
          pInputText 
          [(ngModel)]="selectedMessage.uzytkownik"
          [style]="{'width': '100%'}"
          readonly
          [disabled]="true"
        />
      </div>

      <div class="detail-field">
        <label for="detail-data-podmiotu">Data przesłania dokumentu</label>
        <input 
          id="detail-data-podmiotu"
          type="text" 
          pInputText 
          [value]="formatDate(selectedMessage.dataPrzeslaniaPodmiotu)"
          [style]="{'width': '100%'}"
          readonly
          [disabled]="true"
        />
      </div>
    </div>

    <!-- User Message Section (editable only by external users) -->
    <div class="detail-section">
      <label for="detail-wiadomosc-uzytkownika" class="detail-label">Wiadomość użytkownika</label>
      <textarea 
        id="detail-wiadomosc-uzytkownika"
        pInputTextarea
        [(ngModel)]="selectedMessage.wiadomoscUzytkownika"
        rows="5"
        [style]="{'width': '100%'}"
        placeholder="Treść wiadomości użytkownika..."
        [readonly]="!isExternalUser"
        [disabled]="!isExternalUser"
        [class.user-message-readonly]="!isExternalUser"
        [attr.aria-readonly]="!isExternalUser"
      ></textarea>
      <small class="field-hint" *ngIf="!isExternalUser">Pole edytowalne tylko dla użytkowników zewnętrznych.</small>
      <small class="field-hint" *ngIf="isExternalUser">Możesz edytować treść wiadomości.</small>
    </div>

    <!-- UKNF Response Section (readonly fields) -->
    <div class="detail-grid">
      <div class="detail-field">
        <label for="detail-pracownik-uknf">Pracownik UKNF</label>
        <input 
          id="detail-pracownik-uknf"
          type="text" 
          pInputText 
          [(ngModel)]="selectedMessage.pracownikUKNF"
          [style]="{'width': '100%'}"
          readonly
          [disabled]="true"
        />
      </div>

      <div class="detail-field">
        <label for="detail-data-uknf">Data przesłania UKNF</label>
        <input 
          id="detail-data-uknf"
          type="text" 
          pInputText 
          [value]="formatDate(selectedMessage.dataPrzeslaniaUKNF)"
          [style]="{'width': '100%'}"
          readonly
          [disabled]="true"
        />
      </div>
    </div>

    <div class="detail-section">
      <label for="detail-wiadomosc-uknf" class="detail-label">Wiadomość pracownika UKNF</label>
      <textarea 
        id="detail-wiadomosc-uknf"
        pInputTextarea
        [(ngModel)]="selectedMessage.wiadomoscPracownikaUKNF"
        rows="5"
        [style]="{'width': '100%'}"
        placeholder="Treść odpowiedzi UKNF..."
        [readonly]="!isInternalUser"
        [disabled]="!isInternalUser"
        [attr.aria-readonly]="!isInternalUser"
      ></textarea>
      <small class="field-hint" *ngIf="!isInternalUser">Pole edytowalne tylko dla użytkowników wewnętrznych (pracowników UKNF).</small>
      <small class="field-hint" *ngIf="isInternalUser">Możesz edytować treść odpowiedzi UKNF.</small>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button 
      pButton 
      type="button" 
      label="Anuluj" 
      icon="pi pi-times"
      class="p-button-text p-button-secondary"
      (click)="closeDetailsDialog()"
    ></button>
    <button 
      pButton 
      type="button" 
      label="Zapisz i wyślij" 
      icon="pi pi-check"
      class="p-button-primary"
      (click)="saveMessage()"
    ></button>
  </ng-template>
</p-dialog>

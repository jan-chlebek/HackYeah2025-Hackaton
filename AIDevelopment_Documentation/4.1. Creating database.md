# 4.1. Creating Database

## Overview
This document explains how the database schema and data for the UKNF Communication Platform are defined, created, and maintained.

---

## 1. How the Database is Defined and Created

### a. Schema Definition (How the DB Structure is Created)
- The database schema (tables, columns, relationships, constraints, indexes, etc.) is defined in the backend C# code:
	- `backend/UknfCommunicationPlatform.Infrastructure/Data/ApplicationDbContext.cs` (the main DbContext)
	- Entity classes in `Core/Entities/`
	- Entity Framework Core migrations (auto-generated from the above)
- This C# model is the **single source of truth** for the database structure. Any schema change should be made in the C# code and applied via migrations.
- SQL scripts (such as `init-schema.sql`) are provided for manual DB setup or troubleshooting, but are not the authoritative source.

### b. Data Seeding (How Data Gets Created)
- All initial data for development, integration, and CI environments is seeded by the backend C# file:
	- `backend/UknfCommunicationPlatform.Infrastructure/Data/DatabaseSeeder.cs`
	- This file programmatically inserts all roles, permissions, users, entities, messages, reports, cases, announcements, file libraries, FAQ, contacts, password policy, etc. using Entity Framework Core.
	- It ensures seeded data is always consistent with the backend model, including hashed passwords and all relationships.
	- **If you want to change or add seeded data, do it in `DatabaseSeeder.cs`.**

**Summary:**
- The schema is defined by `ApplicationDbContext.cs` + entity classes + migrations.
- Data is seeded by `DatabaseSeeder.cs`.
- SQL scripts are for manual schema setup only.

### c. Integration with Backend
- The backend uses Entity Framework Core migrations to keep the database schema in sync with the C# model.
- Connection strings and credentials are managed via environment variables and Docker Compose.
- Backend API endpoints map directly to the main tables (users, entities, reports, messages, cases, etc.).

---

## 2. Database Structure (as of v4)

### Main Tables (by module)
- **Identity & Access:** users, roles, permissions, user_roles, role_permissions, password_policies, password_histories, refresh_tokens
- **Communication:** messages, message_attachments, announcements, announcement_recipients, announcement_attachments, announcement_reads, announcement_histories
- **Administration:** entities, reports, cases, case_documents, case_histories, file_libraries, file_library_permissions, contacts, contact_groups, contact_group_members, faq_questions, faq_ratings

### Relationships
- See `database/diagrams/database_schema_v4.dot` and its PNG/PDF/SVG exports for a visual overview.
- All relationships are enforced with foreign keys and indexes for performance.
- ENUMs are used for status/type fields (e.g., user_role, report_status, case_status).

---

## 3. Usage & Maintenance

### Running the Schema
- For development, the backend automatically applies migrations and seeds data when starting up.
- For manual DB setup (Docker):
  ```powershell
  docker-compose up -d db
  Get-Content database/init-schema.sql | docker exec -i uknf-db psql -U postgres -d uknf_platform
  ```

### Maintenance
- Backups: Use `pg_dump` for full or table-specific backups.
- Triggers keep `updated_at` columns current.
- Indexes and constraints ensure performance and data integrity.

---

## 4. Data Model Highlights
- User-to-entity permissions (user_entity_permissions) for fine-grained access.
- Reporting, messaging, and case management workflows are fully normalized.
- File library supports permissions and versioning.
- Audit and history tables for compliance.

---

## 5. Reference
- See `database/README.md` and `database/SCHEMA_REFERENCE.md` for detailed table/field info and query examples.
- See `database/DATABASE_LOADED_SUMMARY.md` for current data statistics and test coverage.
- See `database/diagrams/database_schema_v4.dot` for the latest schema diagram.

---

*Last updated: 2025-10-05*
